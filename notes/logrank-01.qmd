# 비모수적 방법을 이용한  생존함수의 비교 {#sec-logrank}


## 비모수적 방법을 이용한  생존함수의 비교

두 개의 독립 집단에 대하여 다음과 같이 생존시간을 관측하였다고 하자.

$$
\begin{aligned}
\text{group 1} \quad & (X_{11}, \delta_{11}), (X_{12}, \delta_{12}) , \dots ,(X_{1 n_1}, \delta_{1 n_1}) \\
\text{group 2} \quad & (X_{21}, \delta_{21}), (X_{22}, \delta_{22}) , \dots ,(X_{2 n_2}, \delta_{2 n_2}) \\
\end{aligned}
$$

두 개의 집단에 대한 생존함수가 동일하다는 다음 가설을 고려하자.

 $$ 
 H_0: S_1 = S_2 \quad H_1: S_1 \ne S_2  
 $$

위의 가설은 두 집단의 생존시간을 모두 합쳐서 순서대로 나열하고  중도절단이 없는 자료들에서 다음과 같은 $2\times 2$  분할표를 작성한 다음 CMH-검정 통계량(코크란-맨텔-핸젤 검정 통계량)을 이용하여 검정할 수 있다. 

| 처리/반응여부  | 사망    |  생존  | 합계 |
|:---------------:|:---------:|:----------:|:-----:|
| 1 | $A=a$ | $b$  |  $n_1$ |
| 2 |  $c$ | $d$  |  $n_2$ |
| 합계 | $m_1$ | $m_2$ | $n$ |

다음과 같은 예제 자료를 고려해보자 

$$
\begin{aligned}
\text{[group 1]} \quad & 3,~~5,~~7,~~9+~~, 18 \\
\text{[group 2]} \quad & 12,~~ 19,~~ 20,~~ 20+,~~ 33+ \\
\end{aligned}
$$

두 표본을 합쳐서 순서대로 놓으면 다음과 같다.

$$ 
3,~~5,~~7,~~9+~~12,~~ 18, ~~ 19,~~ 20,~~ 20+,~~ 33+  
$$

이제 중도절단이 없는 자료들($3,5,7,12,18,19,20$)에 대하여 각각  $2\times 2$  분할표를 작성하고  CMH-검정 통계량을 계산할 수 있다. 


먼저 가장 짧은 생존시간 $X=3$이 관측 된 경우 $2\times 2$  분할표를 작성해보자. 

| 처리/반응여부  | 사망    |  생존  | 합계 |
|:---------------:|:---------:|:----------:|:-----:|
| 1 | 1 | 4  |  5|
| 2 |  0 | 5  |  5 |
| 합계 | 1 | 9 | 10 |

:첫번째 분할표

첫번째 분할표에서 귀무가설이 참인 경우, 즉 두 그룹의 생존시간에 대한 분포가 동일한 경우 $A$ 에 대한 기대값은 다음과 같다.

$$ 
E_0(A) = \frac{n_1 m_1}{n} = \frac{(5)(1)}{10} = 0.5 
$$

또한 분산은 다음과 같다.

$$ 
Var_0 (A) = \frac{n_1 n_2 m_1 m_2}{n^2(n-1)} =\frac{m_1 m_2}{(n-1)} \frac{n_1 n_2}{n^2} = \frac{(1)(9)}{9} \frac{(5)(5)}{10^2} =     0.25 
$$


이제 두 번째 생존시간 $X=5$이 관측 된 경우 $2\times 2$  분할표를 작성해보자. 

| 처리/반응여부  | 사망    |  생존  | 합계 |
|:---------------:|:---------:|:----------:|:-----:|
| 1 | 1 | 3  |  4|
| 2 |  0 | 5  |  5 |
| 합계 | 1 | 8 | 9 |

:두번째 분할표

두번째 분할표에서 귀무가설이 참인 경우, 즉 두 그룹의 생존시간에 대한 분포가 동일한 경우 $A$ 에 대한 기대값은 다음과 같다.

$$ 
E_0(A) = \frac{n_1 m_1}{n} = \frac{(4)(1)}{9} = 0.44 
$$

또한 분산은 다음과 같다.

$$ 
Var_0 (A) = \frac{n_1 n_2 m_1 m_2}{n^2(n-1)}  = \frac{(1)(8)}{8} \frac{(5)(4)}{9^2} =     0.2469 
$$


이제 네 번째 생존시간 $X=12$이 관측 된 경우 $2\times 2$  분할표를 작성해보자.  참고로 원자료에서 생존시간이 $X=9$ 로 관측된 경우는 중도절단이 된 관측값이므로  분할표를 작성을 하지 않는다.

| 처리/반응여부  | 사망    |  생존  | 합계 |
|:---------------:|:---------:|:----------:|:-----:|
| 1 | 0 | 1  |  1|
| 2 |  1 | 4  |  5 |
| 합계 | 1 | 5 | 6 |

:네번째 분할표

네번째 분할표에서 귀무가설이 참인 경우, 즉 두 그룹의 생존시간에 대한 분포가 동일한 경우 $A$ 에 대한 기대값은 다음과 같다.

$$ 
E_0(A) = \frac{n_1 m_1}{n} = \frac{(1)(1)}{6} = 0.17 
$$

또한 분산은 다음과 같다.

$$ 
Var_0 (A) = \frac{n_1 n_2 m_1 m_2}{n^2(n-1)}  = \frac{(1)(5)}{5} \frac{(1)(5)}{6^2} =    0.1388
$$



이런 식으로 중도절단이 되지 않은 생존시간이 발생했을 때 마다  위험집단에 있는 개체들에 대하여  $2\times 2$  분할표를 작성하여 $a$ 의 기대값과 분산을 계속 계산한다. 중도 절단이 되지 않은 7개의 생존시간에 대한 $2\times 2$  분할표들에서 얻은 
계산결과를 정리하면 다음표와 같다.


| $X$ | $n$ |  $m_1$ |  $n_1$  |  $a$ | $E_0(A)$ | $a-E_0(A)$ | $m_1 m_2/(n-1)$ | $n_1 n_2 /n^2$ |
|:----:|:----:|:----:|:----:|:----:|:----:|:----:|:----:|:----:
| 3 | 10 | 1 | 5 | 1 | 0.50 | 0.50   | 1 | 0.2500 |
| 5 | 9  | 1 | 4 | 1 | 0.44 | 0.56   | 1 | 0.2469 |
| 7 | 8  | 1 | 3 | 1 | 0.38 | 0.62   | 1 | 0.2344 |
| 12 | 6 | 1 | 1 | 0 | 0.17 | -0.17  | 1 | 0.1389 |
| 18 | 5 | 1 | 1 | 1 | 0.20 |  0.80  | 1 | 0.1600  |
| 19 | 4 | 1 | 0 | 0 | 0    |  0     | 1 | 0    |
| 20 | 3 | 1 | 0 | 0 | 0    |  0     | 1 | 0     |

:분할표들에서 얻은 계산결과

이제 위의 표를 이용하여 다음과 같이 CMH 통계량을 계산할 수 있다.


$$
CMH ~~\chi^2 = \frac {[ \sum (a-E_0(A))]^2}{ \sum [m_1 m_2/(n-1)][n_1 n_2 /n^2] }  
(\#eq:logranktest)
$$


여기서 

$$
\begin{aligned}
\sum (a-E_0(A)) & = 0.50 + 0.56 + 0.62 -0.17 + 0.80 \\
& = 2.31 \\
 \sum [m_1 m_2/(n-1)][n_1 n_2 /n^2] & = (1)(0.2500) + (1)(0.2469) + (1)(0.2344)  \\
 &+ (1)(0.1389) + (1)(0.1600) + (1)(0) + (1)(0) \\
 & = 1.0302
\end{aligned}
$$ 
따라서 

$$
CMH ~~\chi^2 = \frac{(2.31)^2} {1.0302}  = 5.1796   
$$



유의수준 $\alpha=0.05$에서 $\chi^2(1,0.95) = 3.84159 <5.1796$이므로 $H_0$를 기각한다. 즉 두 집단의 생존함수는 같지 않다.


```{r}
t <- c(3, 5, 7, 9, 12,  18,   19,  20,  20,  33)
delta <- c(1,1,1,0,1,1,1,1,0,0)
treat <- c("A", "A", "A", "A", "B", "A", "B", "B", "B", "B")
df <- data.frame(t, delta, treat)
res.comp <- survdiff(Surv(t, delta) ~ treat, data=df)
```


## 일반화 로그 순위 검정

식 \@ref(eq:logranktest) 에 주어진 로그-순위 건정법은 다음과 같이 각 시점마다 다른 가중치 $w_i$를 적용하여 일반화 할 수 있다.


$$
CMH ~~\chi^2 = \frac {[ \sum w_i (a-E_0(A))]^2}{ \sum w_i^2 [m_1 m_2/(n-1)][n_1 n_2 /n^2] }  
(\#eq:logranktest2)
$$

아래 표는 식 \@ref(eq:logranktest2) 에 주어진 일반화 로그-순위 검정에서 가준치의 형태와 해당하는 추정량의 이름이 나타나 있다.

| 가중치 $w_i$의 형태 |  추정량 이름 |  참고 |
|:-----------:|:----------------|:--------------| 
|  1   | Log rank |  |
|  $n_i$ | Wilcoxon | $n_i$ 는 위험집단의 수 |
| $\sqrt{n_i}$ | Tarone–Ware |  |
| $\tilde S(t_i)$ | Peto |  $\tilde S(t_i)$는 그룹을 합쳐서 구한 생존함수 추량 |
|$\hat S (t_{i-1})^p [1 − \hat S(t_{i-1})]^q$ | Flemington–Harrington | $p$ 와 $q$는 0 또는 1 |


## 예제 


### 예제 7.3

교과서 @lee2005park 의 예제 7-3은 흑생종 환자들에 대한 연구로 BCG 와 CP 면영ㄱ법의 생존시간 연장 효과를 비교하기 위한 실험이다. 환자들 중 11명은 BCG 처리를 받고 나머지 19명은 CP 처리를 받았다. 두 그룹의 생존시간에 대한 분포가 다른지 로그-순위 검정을 적용해보자.


먼저 자료는 `example73.txt` 에 저장되어 있다.  

```{r}
df73 <- read.csv("example73.txt", header = T, sep="")
df73$treat <- factor(df73$treat, level=c(1,2), labels = c("BCG", "CP"))
df73
```

로그-순위검정은 함수 `survdiff()` 를 이용하여 다음과 같이 수행할 수 있다.

```{r}
exam73res <- survdiff(Surv(time, censor) ~ treat, data=df73)
exam73res
```


```{r}
exam73comp <- survfit(Surv(time, censor) ~ treat, data=df73)
plot(exam73comp, xlab="Time in months", ylab="Survival probability", col=c("blue", "red"), lwd=2)
legend("topright", legend=c("BCG", "CP"), col=c("blue","red"), lwd=2)
```



  